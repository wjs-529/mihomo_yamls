name: Backup & Cleanup

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_run:      # ç›‘å¬ "Generate Sub-READMEs" å®Œæˆåè§¦å‘
    workflows: ["Generate Sub-READMEs"]
    types:
      - completed

permissions:
  contents: write # å…è®¸å‘å¸ƒ Release
  actions: write  # å…è®¸åˆ é™¤ Workflow Runs

jobs:
  backup-and-release:
    runs-on: ubuntu-latest
    # ä»…åœ¨ç”Ÿæˆæ–‡æ¡£æˆåŠŸåï¼Œæˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: æ£€æŸ¥ä»£ç ä»“åº“
        uses: actions/checkout@v6

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: è·å–æ—¶é—´æˆ³
        run: echo "TIMESTAMP=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_ENV

      - name: ç”Ÿæˆè¯¦ç»†æ¸…å•å¹¶æ‰“åŒ…
        run: |
          # --- 1. ä½¿ç”¨ Python ç”Ÿæˆç±»ä¼¼äº README çš„è¯¦ç»†æ¸…å• ---
          python3 -c '
          import os

          timestamp = "${{ env.TIMESTAMP }}"
          
          # å®šä¹‰åˆ†ç±»æ˜ å°„ (ä¸é¦–é¡µä¿æŒä¸€è‡´)
          CATEGORY_MAP = {
              "Official_Examples": "Mihomo å®˜æ–¹ç¤ºä¾‹ (Official)",
              "General_Config": "é€šç”¨è¿›é˜¶é…ç½® (General Config)",
              "Smart_Mode": "Smart æ¨¡å¼ / è·¯ç”±ä¸“ç”¨ (Smart Mode)",
              "Mobile_Modules": "Android æ‰‹æœºæ¨¡å— (Mobile Modules)"
          }

          lines = []
          lines.append(f"## ğŸ“¦ è‡ªåŠ¨å¤‡ä»½ (Auto Backup)")
          lines.append(f"> ğŸ•’ **æ—¶é—´ (Time):** {timestamp}")
          lines.append(f"> ğŸ’¾ **è¯´æ˜:** æœ¬æ¬¡ Release åŒ…å«ä»¥ä¸‹åˆ†ç±»çš„æ‰€æœ‰æœ€æ–°é…ç½®ã€‚\n")

          def get_size_str(path):
              try:
                  size = os.path.getsize(path)
                  if size < 1024: return f"{size} B"
                  return f"{size/1024:.1f} KB"
              except: return "N/A"

          # éå†é¢„å®šä¹‰çš„åˆ†ç±»æ–‡ä»¶å¤¹
          for folder, title in CATEGORY_MAP.items():
              if not os.path.exists(folder): continue
              
              lines.append(f"### ğŸ“‚ {title}")
              lines.append("| æ–‡ä»¶è·¯å¾„ (Path) | å¤§å° (Size) |")
              lines.append("| :--- | :--- |")
              
              has_files = False
              # éå†è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
              for root, dirs, files in os.walk(folder):
                  for file in sorted(files):
                      # æ’é™¤ç”Ÿæˆçš„ README å’Œç³»ç»Ÿæ–‡ä»¶
                      if file == "README.md" or file.startswith("."): continue
                      
                      full_path = os.path.join(root, file)
                      # æ˜¾ç¤ºç›¸å¯¹è·¯å¾„ (ä¾‹å¦‚: HenryChiao/MihomoAIO.yaml)
                      rel_path = os.path.relpath(full_path, folder)
                      size = get_size_str(full_path)
                      
                      lines.append(f"| `{rel_path}` | {size} |")
                      has_files = True
              
              if not has_files:
                  lines.pop() # åˆ é™¤è¡¨å¤´
                  lines.pop()
                  lines.append("_æš‚æ— æ–‡ä»¶_")
              
              lines.append("") # ç©ºè¡Œåˆ†éš”

          # å†™å…¥ release_body.md
          with open("release_body.md", "w", encoding="utf-8") as f:
              f.write("\n".join(lines))
          '

          # --- 2. æ‰“åŒ…æ–‡ä»¶ ---
          sudo apt-get install -y zip
          # -r é€’å½’
          # -x æ’é™¤: gitç›®å½•, githubç›®å½•, æ‰€æœ‰README.md, ä»¥åŠç”Ÿæˆçš„ release_body.md
          zip -r "Config_Backup_${{ env.TIMESTAMP }}.zip" . -x ".git/*" ".github/*" "*/README.md" "README.md" "release_body.md"

          echo "âœ… æ¸…å•ç”Ÿæˆå®Œæ¯•ï¼Œæ‰“åŒ…å®Œæˆã€‚"

      - name: å‘å¸ƒ Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "backup-${{ env.TIMESTAMP }}"
          name: "ğŸ“… è‡ªåŠ¨å¤‡ä»½: ${{ env.TIMESTAMP }}"
          body_path: release_body.md
          files: Config_Backup_${{ env.TIMESTAMP }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  cleanup-workflows:
    runs-on: ubuntu-latest
    needs: backup-and-release
    steps:
      # æ¸…ç† 1: Update File Test
      - name: æ¸…ç† Update File Test
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1
          delete_workflow_pattern: "Update File Test"

      # æ¸…ç† 2: Generate Sub-READMEs
      - name: æ¸…ç† Generate Sub-READMEs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1
          delete_workflow_pattern: "Generate Sub-READMEs"

      # æ¸…ç† 3: Backup & Cleanup
      - name: æ¸…ç† Backup & Cleanup
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 1
          delete_workflow_pattern: "Backup & Cleanup"
