name: Update All GeoData Assets

on:
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *' # åŒ—äº¬æ—¶é—´ 04:00
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-geodata.yml'

permissions:
  contents: write

jobs:
  process-and-publish:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      TZ: Asia/Shanghai
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- æ­¥éª¤ 0: å‡†å¤‡å†å²æ•°æ® (ç”¨äºå·®å¼‚å¯¹æ¯”) ---
      - name: Fetch old stats
        continue-on-error: true
        run: |
          # å°è¯•è·å–è¿œç¨‹ GeoData åˆ†æ”¯çš„ stats.json ç”¨äºå¯¹æ¯”
          mkdir -p old_data
          git ls-remote --exit-code --heads origin GeoData
          if [ $? -eq 0 ]; then
             git archive --remote=origin GeoData stats.json | tar -x -C old_data || echo "No stats.json found"
          fi

      # --- æ­¥éª¤ 1: å®‰è£…å¿…è¦å·¥å…· ---
      - name: Setup Go and Tools
        run: |
          echo "ğŸ› ï¸ Installing v2dat (Unpack tool)..."
          # å®‰è£… v2datï¼Œä¸“é—¨ç”¨äºè§£åŒ… geoip/geosite
          go install github.com/urlesistiana/v2dat@latest
          
          # å°† Go Bin åŠ å…¥è·¯å¾„
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # --- æ­¥éª¤ 2: ä¸‹è½½ä¸æ•´ç† (ä¿ç•™ä½ åŸæœ‰çš„é€»è¾‘) ---
      - name: Download and Sort Assets
        run: |
          function sort_files() {
            local author_dir=$1
            cd "$author_dir" || return
            mkdir -p geoip geosite asn uncategorized
            find . -maxdepth 1 -type f | while read file; do
              filename=$(basename "$file")
              lower_name=$(echo "$filename" | tr '[:upper:]' '[:lower:]')
              if [[ "$lower_name" == *"geoip"* ]] || [[ "$lower_name" == *".mmdb"* ]]; then
                mv "$filename" geoip/
              elif [[ "$lower_name" == *"geosite"* ]] || [[ "$lower_name" == *"dlc.dat"* ]]; then
                mv "$filename" geosite/
              elif [[ "$lower_name" == *"asn"* ]]; then
                mv "$filename" asn/
              else
                mv "$filename" uncategorized/
              fi
            done
            rmdir geoip geosite asn uncategorized 2>/dev/null || true
            cd - > /dev/null
          }

          mkdir -p workspace
          cd workspace

          echo "ğŸš€ Downloading MetaCubeX..."
          mkdir -p MetaCubeX && gh release download latest --repo MetaCubeX/meta-rules-dat --dir MetaCubeX --pattern "*" --clobber
          sort_files "$(pwd)/MetaCubeX"

          echo "ğŸš€ Downloading DustinWin..."
          mkdir -p DustinWin && gh release download mihomo-geodata --repo DustinWin/ruleset_geodata --dir DustinWin --pattern "*" --clobber
          sort_files "$(pwd)/DustinWin"

          echo "ğŸš€ Downloading NobyDa..."
          mkdir -p NobyDa && gh release download --repo NobyDa/geoip --dir NobyDa --pattern "*" --clobber
          sort_files "$(pwd)/NobyDa"

          echo "ğŸš€ Downloading Loyalsoldier..."
          mkdir -p Loyalsoldier
          gh release download --repo Loyalsoldier/v2ray-rules-dat --dir Loyalsoldier --pattern "*" --clobber
          gh release download --repo Loyalsoldier/geoip --dir Loyalsoldier --pattern "*" --clobber
          sort_files "$(pwd)/Loyalsoldier"

          echo "ğŸš€ Downloading xream..."
          mkdir -p xream && gh release download --repo xream/geoip --dir xream --pattern "*" --clobber
          sort_files "$(pwd)/xream"

      # --- æ­¥éª¤ 3: æ ¸å¿ƒå¤„ç† (è§£åŒ…ã€ç»Ÿè®¡ã€ç”Ÿæˆ README) ---
      - name: Process Data & Generate Report
        run: |
          # è¿è¡Œ Python è„šæœ¬å¤„ç†æ•°æ®
          python3 .github/scripts/analyze_geodata.py

      # --- æ­¥éª¤ 4: æ¨é€ (ä½¿ç”¨ä½ æä¾›çš„å‚è€ƒé€»è¾‘) ---
      - name: Git push assets to "GeoData" branch
        run: |
          # å°†ç”Ÿæˆçš„å†…å®¹ç§»åŠ¨åˆ° push ç›®å½•
          mkdir -p push
          cp -r workspace/* push/
          
          cd push || exit 1
          
          # åˆå§‹åŒ– git (å­¤å„¿åˆ†æ”¯æ¨¡å¼)
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # è¿™é‡Œçš„ -b GeoData å¯¹åº”ä½ åŸæœ‰çš„åˆ†æ”¯åï¼Œä¿æŒè®¢é˜…é“¾æ¥ä¸å˜
          git checkout -b GeoData
          
          git add .
          git commit -m "Auto Update Assets & Report: $(date +'%Y-%m-%d %H:%M:%S')"
          
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          git push -f origin GeoData

      # --- æ­¥éª¤ 5: åˆ·æ–° CDN (å‚è€ƒé€»è¾‘) ---
      - name: Purge jsdelivr CDN
        continue-on-error: true
        run: |
          # åªåˆ·æ–°æ ¹ç›®å½•çš„ README å’Œå…³é”® stats.jsonï¼Œé¿å…éå†æˆåƒä¸Šä¸‡ä¸ªæ–‡ä»¶å¯¼è‡´è¶…æ—¶
          curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@GeoData/README.md"
          curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@GeoData/stats.json"
          
          # å¦‚æœéœ€è¦åˆ·æ–°ç‰¹å®šæ–‡ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
