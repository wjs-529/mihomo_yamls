name: Update File Test

on:
  schedule:
    - cron: '30 22 * * *' # UTC 22:30 = 北京时间次日6:30
  workflow_dispatch: # 允许手动触发

# --- [修复核心] 添加写入权限 ---
permissions:
  contents: write

jobs:
  update-files:
    runs-on: ubuntu-latest
    steps:
      - name: 检查存储库
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }} # 显式指定检出当前触发的分支

      - name: 创建分类文件夹并下载配置
        run: |
          # ==========================================
          # 1. 官方示例 (Official_Examples)
          # ==========================================
          
          # --- Metacubex ---
          mkdir -p "Official_Examples/Metacubex"
          curl -s -o "Official_Examples/Metacubex/rule-set_config.yaml" \
            "https://wiki.metacubex.one/example/mrs"
          curl -s -o "Official_Examples/Metacubex/geox_config.yaml" \
            "https://wiki.metacubex.one/example/geox"


          # ==========================================
          # 2. 通用配置 (General_Config)
          # ==========================================

          # --- Yiteei ---
          mkdir -p "General_Config/Yiteei"
          curl -s -o "General_Config/Yiteei/redir-host_config.yaml" \
            "https://raw.githubusercontent.com/yiteei/Share/refs/heads/Proxy/config/redir-host.yaml"
          curl -s -o "General_Config/Yiteei/fake-ip_config.yaml" \
            "https://raw.githubusercontent.com/yiteei/Share/refs/heads/Proxy/config/fake-ip.yaml"

          # --- JohnsonRan ---
          mkdir -p "General_Config/JohnsonRan"
          curl -s -o "General_Config/JohnsonRan/AIB.yaml" \
            "https://raw.githubusercontent.com/JohnsonRan/CRules/refs/heads/master/config/AIB.yaml"
          curl -s -o "General_Config/JohnsonRan/AIO.yaml" \
            "https://raw.githubusercontent.com/JohnsonRan/CRules/refs/heads/master/config/AIO.yaml"
          
          # --- 666OS (MihomoPro & OneTouch) ---
          mkdir -p "General_Config/666OS"
          curl -s -o "General_Config/666OS/MihomoPro_Config.yaml" \
            "https://raw.githubusercontent.com/666OS/YYDS/main/mihomo/config/MihomoPro.yaml"
          curl -s -o "General_Config/666OS/OneTouch_Config.yaml" \
            "https://raw.githubusercontent.com/666OS/YYDS/main/mihomo/config/OneTouch.yaml"

          # --- HenryChiao (General) ---
          mkdir -p "General_Config/HenryChiao"
          curl -s -o "General_Config/HenryChiao/MihomoAIO.yaml" \
            "https://raw.githubusercontent.com/HenryChiao/MIHOMO_AIO/refs/heads/main/CONFIG/General/MihomoAIO.yaml"
          curl -s -o "General_Config/HenryChiao/MihomoProMax.yaml" \
            "https://raw.githubusercontent.com/HenryChiao/MIHOMO_AIO/refs/heads/main/CONFIG/General/MihomoProMax.yaml"
          curl -s -o "General_Config/HenryChiao/MihomoProPlus.yaml" \
            "https://raw.githubusercontent.com/HenryChiao/MIHOMO_AIO/refs/heads/main/CONFIG/General/MihomoProPlus.yaml"

          # --- yyhhyyyyyy (SelfProxy) ---
          mkdir -p "General_Config/yyhhyyyyyy"
          curl -s -o "General_Config/yyhhyyyyyy/mihomo_single.yaml" \
            "https://raw.githubusercontent.com/yyhhyyyyyy/selfproxy/refs/heads/main/Mihomo/mihomo_single.yaml"
          curl -s -o "General_Config/yyhhyyyyyy/mihomo_multi.yaml" \
            "https://raw.githubusercontent.com/yyhhyyyyyy/selfproxy/refs/heads/main/Mihomo/mihomo_multi.yaml"

          # --- liandu2024 (General/Fallback) ---
          mkdir -p "General_Config/liandu2024"
          curl -s -o "General_Config/liandu2024/clash-fallback.yaml" \
            "https://raw.githubusercontent.com/liandu2024/little/refs/heads/main/yaml/clash-fallback.yaml"
          curl -s -o "General_Config/liandu2024/clash-fallback-std.yaml" \
            "https://raw.githubusercontent.com/liandu2024/little/refs/heads/main/yaml/clash-fallback-std.yaml"
          curl -s -o "General_Config/liandu2024/clash-fallback-dialer.yaml" \
            "https://raw.githubusercontent.com/liandu2024/little/refs/heads/main/yaml/clash-fallback-dialer.yaml"
          curl -s -o "General_Config/liandu2024/clash-fallback-all.yaml" \
            "https://raw.githubusercontent.com/liandu2024/little/refs/heads/main/yaml/clash-fallback-all.yaml"
          curl -s -o "General_Config/liandu2024/clash-all-fallback.yaml" \
            "https://raw.githubusercontent.com/liandu2024/little/refs/heads/main/yaml/clash-all-fallback.yaml"
          
          # --- ClashConnectRules ---
          mkdir -p "General_Config/ClashConnectRules"
          curl -s -o "General_Config/ClashConnectRules/Clash.yaml" \
            "https://raw.githubusercontent.com/ClashConnectRules/Self-Configuration/refs/heads/main/Clash.yaml"

          # --- Lanlan13-14 ---
          mkdir -p "General_Config/Lanlan13-14"
          curl -s -o "General_Config/Lanlan13-14/configfull.yaml" "https://raw.githubusercontent.com/Lanlan13-14/Rules/refs/heads/main/configfull.yaml"
          curl -s -o "General_Config/Lanlan13-14/configfull_lite.yaml" "https://raw.githubusercontent.com/Lanlan13-14/Rules/refs/heads/main/configfull_lite.yaml"
          curl -s -o "General_Config/Lanlan13-14/configfull_NoAd.yaml" "https://raw.githubusercontent.com/Lanlan13-14/Rules/refs/heads/main/configfull_NoAd.yaml"

          # --- echs-top (General) ---
          mkdir -p "General_Config/echs-top"
          curl -s -o "General_Config/echs-top/mihomo.yaml" \
            "https://raw.githubusercontent.com/echs-top/proxy/heads/main/mihomo.yaml"

          # --- qichiyuhub (General) ---
          mkdir -p "General_Config/qichiyuhub"
          curl -s -o "General_Config/qichiyuhub/config.yaml" \
            "https://raw.githubusercontent.com/qichiyuhub/rule/refs/heads/main/config/mihomo/config.yaml"

          # --- iKeLee ---
          mkdir -p "General_Config/iKeLee"
          curl -s -o "General_Config/iKeLee/Clash_Sample.yaml" \
            "https://raw.githubusercontent.com/luestr/ProxyResource/main/Tool/Clash/Config/Clash_Sample_Config_By_iKeLee.yaml"

          # --- Fᴜғᴜ ---
          mkdir -p "General_Config/fufu"
          curl -s -o "General_Config/fufu/ConfigForClash.yaml" \
            "https://raw.githubusercontent.com/sunfing/iNg/refs/heads/main/Config/ConfigForClash"

          # --- liuran001 ---
          mkdir -p "General_Config/liuran001"
          curl -s -o "General_Config/liuran001/config.yaml" \
            "https://gist.githubusercontent.com/liuran001/5ca84f7def53c70b554d3f765ff86a33/raw/9de058af0600fbbcfb480f9cbc23bd7dafe9d039/config.yaml"

          # --- 新项目名称 (自定义) ---
          # mkdir -p "General_Config/新项目文件夹名"
          # curl -s -o "General_Config/新项目文件夹名/config.yaml" \
            # "这里粘贴你的raw文件下载链接"




          # ==========================================
          # 3. Smart模式 (Smart_Mode)
          # ==========================================

          # --- 666OS (Smart系列) ---
          mkdir -p "Smart_Mode/666OS"
          curl -s -o "Smart_Mode/666OS/OneSmart_Config.yaml" \
            "https://raw.githubusercontent.com/666OS/YYDS/main/mihomo/config/OneSmartPro.yaml"
          curl -s -o "Smart_Mode/666OS/OneSmart_Lite_Config.yaml" \
            "https://raw.githubusercontent.com/666OS/YYDS/main/mihomo/config/OneSmart.yaml"

          # --- HenryChiao (Smart) ---
          mkdir -p "Smart_Mode/HenryChiao"
          curl -s -o "Smart_Mode/HenryChiao/MihomoSmartProPlus.yaml" \
            "https://raw.githubusercontent.com/HenryChiao/MIHOMO_AIO/refs/heads/main/CONFIG/SMART/MihomoSmartProPlus.yaml"
          curl -s -o "Smart_Mode/HenryChiao/MihomoSmartAIO.yaml" \
            "https://raw.githubusercontent.com/HenryChiao/MIHOMO_AIO/refs/heads/main/CONFIG/SMART/MihomoSmartAIO.yaml"
          curl -s -o "Smart_Mode/HenryChiao/MihomoSmartProMax.yaml" \
            "https://raw.githubusercontent.com/HenryChiao/MIHOMO_AIO/refs/heads/main/CONFIG/SMART/MihomoSmartProMax.yaml"

          # --- liandu2024 (Smart) ---
          mkdir -p "Smart_Mode/liandu2024"
          curl -s -o "Smart_Mode/liandu2024/clash-fallback-smart-std.yaml" \
            "https://raw.githubusercontent.com/liandu2024/little/refs/heads/main/yaml/clash-fallback-smart-std.yaml"
          curl -s -o "Smart_Mode/liandu2024/clash-all-smart.yaml" \
            "https://raw.githubusercontent.com/liandu2024/little/refs/heads/main/yaml/clash-all-smart.yaml"
          curl -s -o "Smart_Mode/liandu2024/clash-all-fallback-smart.yaml" \
            "https://raw.githubusercontent.com/liandu2024/little/refs/heads/main/yaml/clash-all-fallback-smart.yaml"

          # --- echs-top (Smart) ---
          mkdir -p "Smart_Mode/echs-top"
          curl -s -o "Smart_Mode/echs-top/mihomo_smart.yaml" \
            "https://raw.githubusercontent.com/echs-top/proxy/heads/main/mihomo_smart.yaml"

          # --- qichiyuhub (Smart) ---
          mkdir -p "Smart_Mode/qichiyuhub"
          curl -s -o "Smart_Mode/qichiyuhub/smart.yaml" \
            "https://raw.githubusercontent.com/qichiyuhub/rule/refs/heads/main/config/mihomo/AI/smart.yaml"


          # ==========================================
          # 4. 手机模块 (Mobile_Modules)
          # ==========================================

          # --- Surfing ---
          mkdir -p "Mobile_Modules/Surfing"
          curl -s -o "Mobile_Modules/Surfing/config.yaml" \
            "https://raw.githubusercontent.com/GitMetaio/Surfing/refs/heads/main/box_bll/clash/config.yaml"

          # --- AkashaProxy ---
          mkdir -p "Mobile_Modules/AkashaProxy"
          curl -s -o "Mobile_Modules/AkashaProxy/config.yaml" \
            "https://raw.githubusercontent.com/akashaProxy/akashaProxy/refs/heads/master/module/src/config.example.yaml"

          # --- ClashMix ---
          mkdir -p "Mobile_Modules/ClashMix"
          curl -s -o "Mobile_Modules/ClashMix/config.yaml" \
            "https://raw.githubusercontent.com/AXEVO/Clash-MIX/refs/heads/Clash-MIX-4.0/Clash/Clash%E9%85%8D%E7%BD%AE.yaml"

          # --- BoxProxy ---
          mkdir -p "Mobile_Modules/BoxProxy"
          curl -s -o "Mobile_Modules/BoxProxy/config.yaml" \
            "https://raw.githubusercontent.com/boxproxy/box/refs/heads/master/box/mihomo/config.yaml"

      - name: 提交并推送更改
        run: |
          # 使用 GitHub Actions Bot 标准身份
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add .
          git commit -m "Update config files" || echo "No changes to commit"
          
          # 显式推送到当前触发的分支，避免 detached HEAD 问题
          git push origin HEAD:${{ github.ref_name }}
