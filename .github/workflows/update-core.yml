name: Update Core

on:
  workflow_dispatch:
    inputs:
      projects:
        description: '要更新的项目 (逗号分隔: sing-box,mihomo 或 all)'
        required: false
        default: 'all'
      force_update:
        description: '强制更新（忽略版本检查）'
        required: false
        type: boolean
        default: false
  
  schedule:
    - cron: "0 18 * * *"
  
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-core.yml'
      - '.github/workflows/build-go-project.yml'
      - '.github/workflows/download-binaries.yml'
      - '.github/scripts/**'

jobs:
  # ========================================================================
  # 准备阶段：获取Go版本
  # ========================================================================
  prepare:
    name: 准备构建环境
    runs-on: ubuntu-latest
    outputs:
      go_version: ${{ steps.go.outputs.version }}
    
    steps:
      - name: 获取最新Go版本
        id: go
        run: |
          version=$(curl -sSL https://raw.githubusercontent.com/actions/go-versions/update-versions-manifest-file/versions-manifest.json | \
                    jq -r '.[0].version')
          echo "version=${version}" >> $GITHUB_OUTPUT
          echo "✅ Go版本: ${version}"

  # ========================================================================
  # sing-box版本检测
  # ========================================================================
  check-singbox:
    name: 检测sing-box版本
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.projects == 'all' || 
      github.event.inputs.projects == 'sing-box' || 
      github.event_name != 'workflow_dispatch'
    
    outputs:
      ref1nd_main_version: ${{ steps.versions.outputs.ref1nd_main_version }}
      ref1nd_main_time: ${{ steps.versions.outputs.ref1nd_main_time }}
      ref1nd_main_tags: ${{ steps.versions.outputs.ref1nd_main_tags }}
      ref1nd_main_skip: ${{ steps.compare.outputs.ref1nd_main_skip }}
      
      ref1nd_dev_version: ${{ steps.versions.outputs.ref1nd_dev_version }}
      ref1nd_dev_time: ${{ steps.versions.outputs.ref1nd_dev_time }}
      ref1nd_dev_tags: ${{ steps.versions.outputs.ref1nd_dev_tags }}
      ref1nd_dev_skip: ${{ steps.compare.outputs.ref1nd_dev_skip }}
      
      sagernet_release_version: ${{ steps.versions.outputs.sagernet_release_version }}
      sagernet_release_time: ${{ steps.versions.outputs.sagernet_release_time }}
      sagernet_release_tags: ${{ steps.versions.outputs.sagernet_release_tags }}
      sagernet_release_skip: ${{ steps.compare.outputs.sagernet_release_skip }}
      
      sagernet_dev_version: ${{ steps.versions.outputs.sagernet_dev_version }}
      sagernet_dev_time: ${{ steps.versions.outputs.sagernet_dev_time }}
      sagernet_dev_tags: ${{ steps.versions.outputs.sagernet_dev_tags }}
      sagernet_dev_skip: ${{ steps.compare.outputs.sagernet_dev_skip }}
    
    steps:
      - name: 检测所有版本
        id: versions
        run: |
          # reF1nd-main
          git clone --depth=1 --branch=reF1nd-main https://github.com/reF1nd/sing-box.git /tmp/ref1nd-main 2>/dev/null || true
          if [[ -d /tmp/ref1nd-main ]]; then
            cd /tmp/ref1nd-main
            REF1ND_MAIN_VER=$(git tag -l --sort=-v:refname 2>/dev/null | grep -E '^v?[0-9]+\.[0-9]+\.[0-9]+.*-reF1nd' | head -n1 | sed 's/^v//')
            REF1ND_MAIN_TIME=$(git log -1 --format=%cd --date=format:'%Y-%m-%d' HEAD 2>/dev/null || echo "unknown")
          else
            REF1ND_MAIN_VER="unknown"
            REF1ND_MAIN_TIME="unknown"
          fi
          echo "ref1nd_main_version=${REF1ND_MAIN_VER}" >> $GITHUB_OUTPUT
          echo "ref1nd_main_time=${REF1ND_MAIN_TIME}" >> $GITHUB_OUTPUT
          # 关键修复：移除已弃用的 with_ech 和 with_reality_server 标签
          echo "ref1nd_main_tags=with_gvisor,with_quic,with_dhcp,with_utls,with_clash_api" >> $GITHUB_OUTPUT
          
          # reF1nd-dev
          git clone --depth=1 --branch=reF1nd-dev https://github.com/reF1nd/sing-box.git /tmp/ref1nd-dev 2>/dev/null || true
          if [[ -d /tmp/ref1nd-dev ]]; then
            cd /tmp/ref1nd-dev
            REF1ND_DEV_VER=$(git tag -l --sort=-v:refname 2>/dev/null | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+.*(alpha|beta|rc).*-reF1nd' | head -n1 | sed 's/^v//')
            REF1ND_DEV_TIME=$(git log -1 --format=%cd --date=format:'%Y-%m-%d' HEAD 2>/dev/null || echo "unknown")
          else
            REF1ND_DEV_VER="unknown"
            REF1ND_DEV_TIME="unknown"
          fi
          echo "ref1nd_dev_version=${REF1ND_DEV_VER}" >> $GITHUB_OUTPUT
          echo "ref1nd_dev_time=${REF1ND_DEV_TIME}" >> $GITHUB_OUTPUT
          # 关键修复：移除已弃用的标签
          echo "ref1nd_dev_tags=with_gvisor,with_quic,with_dhcp,with_utls,with_clash_api" >> $GITHUB_OUTPUT
          
          # SagerNet-release
          SAGERNET_REL_API=$(curl -sSL https://api.github.com/repos/SagerNet/sing-box/releases/latest)
          SAGERNET_REL_VER=$(echo "$SAGERNET_REL_API" | jq -r '.tag_name' | sed 's/^v//')
          SAGERNET_REL_TIME=$(echo "$SAGERNET_REL_API" | jq -r '.created_at' | cut -dT -f1)
          echo "sagernet_release_version=${SAGERNET_REL_VER}" >> $GITHUB_OUTPUT
          echo "sagernet_release_time=${SAGERNET_REL_TIME}" >> $GITHUB_OUTPUT
          # 关键修复：移除已弃用的标签
          echo "sagernet_release_tags=with_gvisor,with_quic,with_dhcp,with_utls,with_clash_api" >> $GITHUB_OUTPUT
          
          # SagerNet-dev
          SAGERNET_DEV_API=$(curl -sSL https://api.github.com/repos/SagerNet/sing-box/releases)
          SAGERNET_DEV_VER=$(echo "$SAGERNET_DEV_API" | jq -r '[.[] | select(.prerelease==true)][0].tag_name' | sed 's/^v//')
          SAGERNET_DEV_TIME=$(echo "$SAGERNET_DEV_API" | jq -r '[.[] | select(.prerelease==true)][0].created_at' | cut -dT -f1)
          echo "sagernet_dev_version=${SAGERNET_DEV_VER}" >> $GITHUB_OUTPUT
          echo "sagernet_dev_time=${SAGERNET_DEV_TIME}" >> $GITHUB_OUTPUT
          # 关键修复：移除已弃用的标签
          echo "sagernet_dev_tags=with_gvisor,with_quic,with_dhcp,with_utls,with_clash_api" >> $GITHUB_OUTPUT

      - name: 版本比对
        id: compare
        run: |
          if [[ "${{ github.event.inputs.force_update }}" == "true" ]]; then
            echo "ref1nd_main_skip=false" >> $GITHUB_OUTPUT
            echo "ref1nd_dev_skip=false" >> $GITHUB_OUTPUT
            echo "sagernet_release_skip=false" >> $GITHUB_OUTPUT
            echo "sagernet_dev_skip=false" >> $GITHUB_OUTPUT
          else
            # 简化逻辑：只要不是unknown就不跳过
            [[ "${{ steps.versions.outputs.ref1nd_main_version }}" != "unknown" ]] && echo "ref1nd_main_skip=false" || echo "ref1nd_main_skip=true"
            [[ "${{ steps.versions.outputs.ref1nd_dev_version }}" != "unknown" ]] && echo "ref1nd_dev_skip=false" || echo "ref1nd_dev_skip=true"
            [[ "${{ steps.versions.outputs.sagernet_release_version }}" != "null" ]] && echo "sagernet_release_skip=false" || echo "sagernet_release_skip=true"
            [[ "${{ steps.versions.outputs.sagernet_dev_version }}" != "null" ]] && echo "sagernet_dev_skip=false" || echo "sagernet_dev_skip=true"
          fi

  # ========================================================================
  # mihomo版本检测
  # ========================================================================
  check-mihomo:
    name: 检测mihomo版本
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.projects == 'all' || 
      github.event.inputs.projects == 'mihomo' || 
      github.event_name != 'workflow_dispatch'
    
    outputs:
      meta_version: ${{ steps.versions.outputs.meta_version }}
      meta_time: ${{ steps.versions.outputs.meta_time }}
      meta_skip: ${{ steps.versions.outputs.meta_skip }}
      
      alpha_version: ${{ steps.versions.outputs.alpha_version }}
      alpha_time: ${{ steps.versions.outputs.alpha_time }}
      alpha_skip: ${{ steps.versions.outputs.alpha_skip }}
      
      smart_version: ${{ steps.versions.outputs.smart_version }}
      smart_time: ${{ steps.versions.outputs.smart_time }}
      smart_skip: ${{ steps.versions.outputs.smart_skip }}
    

    steps:
      - name: 检测所有版本
        id: versions
        run: |
          # Meta - 获取最新正式版
          META_API=$(curl -sSL https://api.github.com/repos/MetaCubeX/mihomo/releases/latest)
          META_VER=$(echo "$META_API" | jq -r '.tag_name')
          META_TIME=$(echo "$META_API" | jq -r '.created_at' | cut -dT -f1)
          echo "meta_version=${META_VER}" >> $GITHUB_OUTPUT
          echo "meta_time=${META_TIME}" >> $GITHUB_OUTPUT
          echo "meta_skip=false" >> $GITHUB_OUTPUT
          
          # Alpha - 关键修复：从Prerelease-Alpha的body或tag_name中提取实际版本号
          ALPHA_API=$(curl -sSL https://api.github.com/repos/MetaCubeX/mihomo/releases/tags/Prerelease-Alpha)
          # 尝试从tag_name获取，如果失败则从body中提取
          ALPHA_VER=$(echo "$ALPHA_API" | jq -r '.tag_name')
          if [[ "$ALPHA_VER" == "Prerelease-Alpha" ]] || [[ "$ALPHA_VER" == "null" ]]; then
            # 尝试从body中提取版本号，例如 "Alpha-1.20.0" 或 "1.20.0"
            ALPHA_VER=$(echo "$ALPHA_API" | jq -r '.body' | grep -oP 'mihomo-\K[0-9]+\.[0-9]+\.[0-9]+' | head -n1 || echo "")
            # 如果还是失败，使用发布日期作为版本标识
            if [[ -z "$ALPHA_VER" ]]; then
              ALPHA_VER="alpha-$(echo "$ALPHA_API" | jq -r '.created_at' | cut -dT -f1 | tr -d '-')"
            fi
          fi
          ALPHA_TIME=$(echo "$ALPHA_API" | jq -r '.created_at' | cut -dT -f1)
          echo "alpha_version=${ALPHA_VER}" >> $GITHUB_OUTPUT
          echo "alpha_time=${ALPHA_TIME}" >> $GITHUB_OUTPUT
          echo "alpha_skip=false" >> $GITHUB_OUTPUT
          
          # Smart - 关键修复：vernesong/mihomo的API端点
          SMART_API=$(curl -sSL https://api.github.com/repos/vernesong/mihomo/releases/latest)
          SMART_VER=$(echo "$SMART_API" | jq -r '.tag_name // empty')
          # 如果失败，尝试不带latest的端点
          if [[ -z "$SMART_VER" ]] || [[ "$SMART_VER" == "null" ]]; then
            SMART_API=$(curl -sSL "https://api.github.com/repos/vernesong/mihomo/releases")
            SMART_VER=$(echo "$SMART_API" | jq -r '[.[]][0].tag_name // empty')
          fi
          SMART_TIME=$(echo "$SMART_API" | jq -r '.created_at // .[0].created_at' | cut -dT -f1)
          echo "smart_version=${SMART_VER}" >> $GITHUB_OUTPUT
          echo "smart_time=${SMART_TIME}" >> $GITHUB_OUTPUT
          if [[ -n "$SMART_VER" ]] && [[ "$SMART_VER" != "null" ]]; then
            echo "smart_skip=false" >> $GITHUB_OUTPUT
          else
            echo "smart_skip=true" >> $GITHUB_OUTPUT
          fi

  # ========================================================================
  # sing-box构建任务 - 全平台
  # ========================================================================
  build-singbox-ref1nd-main:
    name: 构建sing-box reF1nd-main
    needs: [prepare, check-singbox]
    if: needs.check-singbox.outputs.ref1nd_main_skip != 'true'
    uses: ./.github/workflows/build-go-project.yml
    with:
      project: sing-box
      variant: ref1nd-main
      version: ${{ needs.check-singbox.outputs.ref1nd_main_version }}
      build_tags: ${{ needs.check-singbox.outputs.ref1nd_main_tags }}
      go_version: ${{ needs.prepare.outputs.go_version }}
  
  build-singbox-ref1nd-dev:
    name: 构建sing-box reF1nd-dev
    needs: [prepare, check-singbox]
    if: needs.check-singbox.outputs.ref1nd_dev_skip != 'true'
    uses: ./.github/workflows/build-go-project.yml
    with:
      project: sing-box
      variant: ref1nd-dev
      version: ${{ needs.check-singbox.outputs.ref1nd_dev_version }}
      build_tags: ${{ needs.check-singbox.outputs.ref1nd_dev_tags }}
      go_version: ${{ needs.prepare.outputs.go_version }}
  
  build-singbox-sagernet-release:
    name: 构建sing-box SagerNet-release
    needs: [prepare, check-singbox]
    if: needs.check-singbox.outputs.sagernet_release_skip != 'true'
    uses: ./.github/workflows/build-go-project.yml
    with:
      project: sing-box
      variant: sagernet-release
      version: ${{ needs.check-singbox.outputs.sagernet_release_version }}
      build_tags: ${{ needs.check-singbox.outputs.sagernet_release_tags }}
      go_version: ${{ needs.prepare.outputs.go_version }}
  
  build-singbox-sagernet-dev:
    name: 构建sing-box SagerNet-dev
    needs: [prepare, check-singbox]
    if: needs.check-singbox.outputs.sagernet_dev_skip != 'true'
    uses: ./.github/workflows/build-go-project.yml
    with:
      project: sing-box
      variant: sagernet-dev
      version: ${{ needs.check-singbox.outputs.sagernet_dev_version }}
      build_tags: ${{ needs.check-singbox.outputs.sagernet_dev_tags }}
      go_version: ${{ needs.prepare.outputs.go_version }}

  # ========================================================================
  # mihomo下载任务 - 全平台（修复版）
  # ========================================================================
  download-mihomo-meta:
    name: 下载mihomo Meta
    needs: [check-mihomo]
    if: needs.check-mihomo.outputs.meta_skip != 'true'
    uses: ./.github/workflows/download-binaries.yml
    with:
      project: mihomo
      variant: meta
      version: ${{ needs.check-mihomo.outputs.meta_version }}
  
  download-mihomo-alpha:
    name: 下载mihomo Alpha
    needs: [check-mihomo]
    if: needs.check-mihomo.outputs.alpha_skip != 'true'
    uses: ./.github/workflows/download-binaries.yml
    with:
      project: mihomo
      variant: alpha
      version: ${{ needs.check-mihomo.outputs.alpha_version }}
  
  download-mihomo-smart:
    name: 下载mihomo Smart
    needs: [check-mihomo]
    if: needs.check-mihomo.outputs.smart_skip != 'true'
    uses: ./.github/workflows/download-binaries.yml
    with:
      project: mihomo
      variant: smart
      version: ${{ needs.check-mihomo.outputs.smart_version }}

  # ========================================================================
  # 产物收集和发布到core分支
  # ========================================================================
  # ========================================================================
  # 产物收集和发布到core分支
  # ========================================================================
  publish:
    name: 发布到Core分支
    runs-on: ubuntu-latest
    needs:
      - check-singbox
      - check-mihomo
      - build-singbox-ref1nd-main
      - build-singbox-ref1nd-dev
      - build-singbox-sagernet-release
      - build-singbox-sagernet-dev
      - download-mihomo-meta
      - download-mihomo-alpha
      - download-mihomo-smart
    if: always()
    
    steps:
      - name: 下载所有产物
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: Setup UPX
        uses: crazy-max/ghaction-upx@v3
        with:
          version: latest
          install-only: true

      - name: 压缩 UPX 文件
        run: |
          # 仅处理标记为 upx 的文件
          find ./artifacts -name "*.upx" -type f -exec upx --best --lzma {} \; 2>/dev/null || true

      - name: 整理产物目录结构
        run: |
          # 创建发布目录
          mkdir -p ./publish
          
          # === 定义目录结构函数 ===
          prepare_dir() {
            mkdir -p "./publish/$1"
          }
          
          # 创建基础结构
          prepare_dir "sing-box/reF1nd/main"
          prepare_dir "sing-box/reF1nd/dev"
          prepare_dir "sing-box/SagerNet/release"
          prepare_dir "sing-box/SagerNet/dev"
          prepare_dir "mihomo/MetaCubeX/meta"
          prepare_dir "mihomo/MetaCubeX/alpha"
          prepare_dir "mihomo/vernesong/smart"

          echo "开始整理 sing-box..."
          # 移动 sing-box 产物
          for file in ./artifacts/sing-box-*; do
            [[ -f "$file" ]] || continue
            filename=$(basename "$file")
            
            # 解析文件名: sing-box-{variant}-{platform}-{arch}.{ext}
            # 例如: sing-box-ref1nd-main-linux-amd64.tar.gz
            # 注意：这里的正则需要根据你实际 build 步骤输出的文件名匹配
            if [[ "$filename" =~ sing-box-([^-]+-[^-]+)-(.+)\.(tar\.gz|upx|exe) ]]; then
              variant="${BASH_REMATCH[1]}" # ref1nd-main
              platform="${BASH_REMATCH[2]}" # linux-amd64
              
              target_base=""
              case "$variant" in
                ref1nd-main)      target_base="sing-box/reF1nd/main" ;;
                ref1nd-dev)       target_base="sing-box/reF1nd/dev" ;;
                sagernet-release) target_base="sing-box/SagerNet/release" ;;
                sagernet-dev)     target_base="sing-box/SagerNet/dev" ;;
              esac
              
              if [[ -n "$target_base" ]]; then
                mkdir -p "./publish/${target_base}/${platform}"
                cp "$file" "./publish/${target_base}/${platform}/"
              fi
            fi
          done
          
          echo "开始整理 mihomo..."
          # 移动 mihomo 产物
          for file in ./artifacts/mihomo-*; do
            [[ -f "$file" ]] || continue
            filename=$(basename "$file")
            
            if [[ "$filename" =~ mihomo-([^-]+)-(.+)\.(tar\.gz|upx|exe) ]]; then
              variant="${BASH_REMATCH[1]}" # meta
              platform="${BASH_REMATCH[2]}" # linux-amd64
              
              target_base=""
              case "$variant" in
                meta)  target_base="mihomo/MetaCubeX/meta" ;;
                alpha) target_base="mihomo/MetaCubeX/alpha" ;;
                smart) target_base="mihomo/vernesong/smart" ;;
              esac
              
              if [[ -n "$target_base" ]]; then
                mkdir -p "./publish/${target_base}/${platform}"
                cp "$file" "./publish/${target_base}/${platform}/"
              fi
            fi
          done

      - name: 生成 Checksum 和 README
        run: |
          cd ./publish
          
          # 生成校验和
          echo "生成校验和..."
          find . -type f \( -name "*.tar.gz" -o -name "*.exe" -o -name "*.upx" \) -exec sha256sum {} \; > global_checksums.txt
          
          # 为每个子目录生成独立的 checksums.txt (可选，如果你需要保持原有逻辑)
          find . -type d -links 2 -exec sh -c 'cd "$1" && sha256sum * > checksums.txt 2>/dev/null || true' _ {} \;

          # 生成 README.md
          cat > README.md <<EOF
          # Core 核心文件仓库

          自动构建的 sing-box 和 mihomo 核心文件。
          
          **最后更新:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')

          ## 目录结构
          \`\`\`text
          sing-box/
          ├── reF1nd/
          │   ├── main/      # reF1nd-main 分支
          │   └── dev/       # reF1nd-dev 分支
          └── SagerNet/
              ├── release/   # SagerNet 正式版
              └── dev/       # SagerNet 开发版

          mihomo/
          ├── MetaCubeX/
          │   ├── meta/      # MetaCubeX 正式版
          │   └── alpha/     # MetaCubeX 测试版
          └── vernesong/
              └── smart/     # OpenClash Smart版
          \`\`\`

          ## 文件格式
          - \`.tar.gz\` - 标准压缩包
          - \`.exe\` - Windows可执行文件
          - \`.upx\` - UPX极限压缩版
          EOF

      - name: 强制推送到 Core 分支
        run: |
          cd ./publish || exit 1
          git init
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b core
          git add .
          git commit -m "Update Cores: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # 关键修改：明确指定带 Token 的 Remote URL
          git remote add origin "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}"
          
          # 强制推送 (覆盖旧记录)
          git push -f origin core

      - name: 删除旧的工作流运行记录
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 3
          keep_minimum_runs: 1
