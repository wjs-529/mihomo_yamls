name: Generate OpenClash Conf

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  # workflow_run:      # ç›‘å¬ "Update File Test" å®Œæˆåè§¦å‘
  #  workflows: ["Update File Test"]
  #  types:
  #    - completed

permissions:
  contents: write

jobs:
  generate-conf:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: æ£€æŸ¥ä»£ç ä»“åº“
        uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install pyyaml

      - name: ç”Ÿæˆ OpenClash ä¸“ç”¨é…ç½®ä¸æ–‡æ¡£
        env:
          GITHUB_REPO: ${{ github.repository }}
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import yaml
          import re
          from urllib.parse import quote

          # ==================== é…ç½®åŒºåŸŸ ====================
          # å®šä¹‰éœ€è¦å¤„ç†çš„æºç›®å½•
          SOURCE_DIRS = [
              "Official_Examples",
              "General_Config", 
              "Smart_Mode",
              "Mobile_Modules"
          ]

          OUTPUT_BASE = "OpenClash_Overview"
          GITHUB_REPO = os.environ.get("GITHUB_REPO", "")
          REPO_RAW_BASE = f"https://raw.githubusercontent.com/{GITHUB_REPO}/main"

          # å¿½ç•¥çš„æ–‡ä»¶
          IGNORE_FILES = ["README.md", "LICENSE", "release_body.md"]

          # é˜²æ­¢ YAML åŠ è½½æŠ¥é”™
          yaml.add_multi_constructor("!", lambda loader, suffix, node: None, Loader=yaml.SafeLoader)

          # ==================== æ ¸å¿ƒå‡½æ•° ====================
          
          def parse_yaml_file(file_path):
              """
              è§£æ YAML æ–‡ä»¶ï¼Œæå– proxy-providers ä¿¡æ¯
              è¿”å›: {
                  "providers": ["provider1", "provider2"],
                  "has_providers": True/False
              }
              """
              try:
                  with open(file_path, "r", encoding="utf-8") as f:
                      content = f.read()
                  
                  # å¤„ç† Tab ç¼©è¿›
                  if "\t" in content:
                      content = content.replace("\t", "  ")
                  
                  data = yaml.safe_load(content)
                  
                  if not isinstance(data, dict):
                      return {"providers": [], "has_providers": False}
                  
                  # æå– proxy-providers
                  providers_dict = data.get("proxy-providers", {})
                  if not isinstance(providers_dict, dict) or not providers_dict:
                      return {"providers": [], "has_providers": False}
                  
                  # è·å–æ‰€æœ‰ provider åç§°
                  provider_names = list(providers_dict.keys())
                  
                  return {
                      "providers": provider_names,
                      "has_providers": len(provider_names) > 0
                  }
                  
              except Exception as e:
                  print(f"âš ï¸  è§£æå¤±è´¥ {file_path}: {e}")
                  return {"providers": [], "has_providers": False}

          def generate_conf_content(filename, raw_url, providers):
              """
              ç”Ÿæˆ OpenClash .conf æ–‡ä»¶å†…å®¹
              
              å‚æ•°:
                  filename: é…ç½®æ–‡ä»¶å (ä¾‹å¦‚: MihomoPro_Config.yaml)
                  raw_url: GitHub Raw æ–‡ä»¶åœ°å€
                  providers: proxy-providers åç§°åˆ—è¡¨
              """
              lines = []
              
              # ==================== [General] åŒºåŸŸ ====================
              lines.append("# --- OpenClash è¦†å†™é…ç½®æ–‡ä»¶ ---")
              lines.append(f"# æºæ–‡ä»¶: {filename}")
              lines.append(f"# ç”Ÿæˆæ—¶é—´: Auto-generated by GitHub Actions")
              lines.append("")
              lines.append("[General]")
              lines.append("DISABLE_UDP_QUIC = 1")
              lines.append("")
              lines.append("#restart: true ä»£è¡¨æ›´æ–°åé‡å¯æ’ä»¶ï¼Œfalse ä»£è¡¨ä¸é‡å¯æ’ä»¶")
              lines.append("#force: true ä»£è¡¨å¼ºåˆ¶ä¸‹è½½ï¼Œfalse ä»£è¡¨ä¸å¼ºåˆ¶ä¸‹è½½ï¼ˆå½“æ–‡ä»¶ä¸å­˜åœ¨æ—¶ä¼šè‡ªåŠ¨ä¸‹è½½ï¼‰")
              lines.append("#cron: å®šæ—¶ä¸‹è½½æ—¶é—´ï¼Œæ ¼å¼ä¸ºæ ‡å‡†çš„ cron è¡¨è¾¾å¼ï¼Œ0 ä»£è¡¨ä¸å¯ç”¨å®šæ—¶ä¸‹è½½")
              lines.append("#ç¤ºä¾‹ï¼šæ¯å¤©å‡Œæ™¨6ç‚¹ä¸‹è½½ä¸€æ¬¡")
              lines.append("#cron=0 6 * * *")
              lines.append("#ç¤ºä¾‹ï¼šæ¯å‘¨ä¸€å‡Œæ™¨6ç‚¹ä¸‹è½½ä¸€æ¬¡")
              lines.append("#cron=0 6 * * 1")
              lines.append(f"DOWNLOAD_FILE = url={raw_url}, path=/etc/openclash/config/{filename}, cron=0 6 * * *, force=false")
              lines.append("")
              lines.append("#å°†æ¨¡æ¿ä½œä¸ºé»˜è®¤é…ç½®æ–‡ä»¶")
              lines.append(f"CONFIG_FILE = /etc/openclash/config/{filename}")
              lines.append("")
              lines.append("#æŒ‡å®šå±•ç¤ºè®¢é˜…ä¿¡æ¯çš„ URL åœ°å€")
              lines.append("SUB_INFO_URL = $EN_KEY1")
              lines.append("")
              
              # ==================== [Overwrite] åŒºåŸŸ ====================
              lines.append("[Overwrite]")
              lines.append("#EN_KEY ä¸ºå¯¹åº”æ¨¡å—éœ€è¦ç”¨æˆ·æŒ‡å®šçš„ç¯å¢ƒå˜é‡å€¼, EN_KEY1=URL1;EN_KEY2=URL2;EN_KEY3=URL3")
              lines.append("#å…¶ä»– Ruby ç¼–è¾‘å‡½æ•°è¯·å‚è€ƒ openclash_custom_overwrite.sh")
              
              if providers:
                  for idx, provider_name in enumerate(providers, start=1):
                      # ç”Ÿæˆ Ruby ç¼–è¾‘å‘½ä»¤
                      line = f'ruby_map_edit "$CONFIG_FILE" "[\'proxy-providers\']" "{provider_name}" "[\'url\']" "$EN_KEY{idx}"'
                      lines.append(line)
              else:
                  lines.append("# æœªæ£€æµ‹åˆ° proxy-providersï¼Œæ— éœ€è¦†ç›–è®¢é˜…é“¾æ¥")
              
              return "\n".join(lines)

          def scan_and_generate():
              """
              æ‰«ææ‰€æœ‰æºç›®å½•ï¼Œç”Ÿæˆ OpenClash é…ç½®æ–‡ä»¶
              """
              print("=" * 70)
              print("OpenClash è¦†å†™é…ç½®ç”Ÿæˆå·¥å…·")
              print("=" * 70)
              print(f"GitHub ä»“åº“: {GITHUB_REPO}")
              print(f"è¾“å‡ºç›®å½•: {OUTPUT_BASE}")
              print("=" * 70)
              
              total_generated = 0
              total_skipped = 0
              
              for source_dir in SOURCE_DIRS:
                  if not os.path.exists(source_dir):
                      print(f"âš ï¸  ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡: {source_dir}")
                      continue
                  
                  print(f"\nğŸ“‚ å¤„ç†ç›®å½•: {source_dir}")
                  print("-" * 70)
                  
                  # éå†æ‰€æœ‰å­æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
                  for root, dirs, files in os.walk(source_dir):
                      # è¿‡æ»¤æ‰éšè—æ–‡ä»¶å¤¹
                      dirs[:] = [d for d in dirs if not d.startswith(".")]
                      
                      for filename in files:
                          # åªå¤„ç† YAML æ–‡ä»¶
                          if filename in IGNORE_FILES or not filename.endswith((".yaml", ".yml")):
                              continue
                          
                          file_path = os.path.join(root, filename)
                          
                          # è§£æ YAML æ–‡ä»¶
                          parsed = parse_yaml_file(file_path)
                          
                          if not parsed["has_providers"]:
                              print(f"â„¹ï¸  è·³è¿‡(æ—  proxy-providers): {file_path}")
                              total_skipped += 1
                              continue
                          
                          # è®¡ç®—ç›¸å¯¹è·¯å¾„
                          rel_path = os.path.relpath(root, ".")
                          
                          # æ„å»º GitHub Raw URL
                          # ä¾‹å¦‚: https://raw.githubusercontent.com/user/repo/main/General_Config/666OS/config.yaml
                          raw_url = f"{REPO_RAW_BASE}/{rel_path.replace(os.sep, '/')}/{quote(filename)}"
                          
                          # æ„å»ºè¾“å‡ºè·¯å¾„
                          # ä¾‹å¦‚: OpenClash_Overview/General_Config/666OS/config.conf
                          output_dir = os.path.join(OUTPUT_BASE, rel_path)
                          os.makedirs(output_dir, exist_ok=True)
                          
                          conf_filename = os.path.splitext(filename)[0] + ".conf"
                          output_path = os.path.join(output_dir, conf_filename)
                          
                          # ç”Ÿæˆ .conf å†…å®¹
                          conf_content = generate_conf_content(
                              filename=filename,
                              raw_url=raw_url,
                              providers=parsed["providers"]
                          )
                          
                          # å†™å…¥æ–‡ä»¶
                          with open(output_path, "w", encoding="utf-8") as f:
                              f.write(conf_content)
                          
                          print(f"âœ… å·²ç”Ÿæˆ: {output_path}")
                          print(f"   - Providers: {', '.join(parsed['providers'])}")
                          print(f"   - Raw URL: {raw_url}")
                          total_generated += 1
              
              # ç»Ÿè®¡ä¿¡æ¯
              print("\n" + "=" * 70)
              print("ç”Ÿæˆå®Œæˆï¼")
              print("=" * 70)
              print(f"âœ… æˆåŠŸç”Ÿæˆ: {total_generated} ä¸ªé…ç½®æ–‡ä»¶")
              print(f"â­ï¸  è·³è¿‡æ–‡ä»¶: {total_skipped} ä¸ª")
              print("=" * 70)

          # ==================== æ‰§è¡Œä¸»å‡½æ•° ====================
          scan_and_generate()
          PYTHON_SCRIPT

      - name: ç”Ÿæˆåˆ†ç±» README
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          
          OUTPUT_BASE = "OpenClash_Overview"
          
          # åˆ†ç±»æè¿°
          CATEGORY_DESC = {
              "Official_Examples": "Mihomo å®˜æ–¹ç¤ºä¾‹é…ç½®",
              "General_Config": "é€šç”¨è¿›é˜¶é…ç½® - é€‚åˆæ—¥å¸¸ä½¿ç”¨",
              "Smart_Mode": "Smart æ¨¡å¼é…ç½® - æ™ºèƒ½é€‰æ‹©èŠ‚ç‚¹",
              "Mobile_Modules": "æ‰‹æœºæ¨¡å—é…ç½® - Root ç¯å¢ƒä¸“ç”¨"
          }
          
          def generate_category_readme(category_path, category_name):
              """ä¸ºæ¯ä¸ªåˆ†ç±»ç”Ÿæˆ README"""
              files = []
              
              # éå†å­æ–‡ä»¶å¤¹æ”¶é›† .conf æ–‡ä»¶
              for root, dirs, filenames in os.walk(category_path):
                  for filename in filenames:
                      if filename.endswith(".conf"):
                          rel_path = os.path.relpath(os.path.join(root, filename), category_path)
                          files.append(rel_path)
              
              if not files:
                  return
              
              # ç”Ÿæˆ README å†…å®¹
              lines = []
              lines.append(f"# ğŸ“ {category_name}")
              lines.append("")
              lines.append(f"> {CATEGORY_DESC.get(category_name, 'é…ç½®æ–‡ä»¶åˆ—è¡¨')}")
              lines.append("")
              lines.append("## ğŸ“‹ é…ç½®æ–‡ä»¶åˆ—è¡¨")
              lines.append("")
              lines.append("| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |")
              lines.append("| :--- | :--- |")
              
              for file_path in sorted(files):
                  lines.append(f"| `{file_path}` | OpenClash è¦†å†™é…ç½® |")
              
              lines.append("")
              lines.append("## ğŸ“– ä½¿ç”¨æ–¹æ³•")
              lines.append("")
              lines.append("1. åœ¨ OpenClash æ’ä»¶ä¸­é€‰æ‹© **é…ç½®æ–‡ä»¶è®¢é˜…**")
              lines.append("2. å°†å¯¹åº”çš„ `.conf` æ–‡ä»¶ Raw é“¾æ¥å¡«å…¥è®¢é˜…åœ°å€")
              lines.append("3. é…ç½®ç¯å¢ƒå˜é‡ `EN_KEY1`ã€`EN_KEY2` ç­‰ä¸ºä½ çš„æœºåœºè®¢é˜…é“¾æ¥")
              lines.append("4. ä¿å­˜å¹¶æ›´æ–°é…ç½®")
              lines.append("")
              lines.append("[ğŸ”™ è¿”å›ä¸»ç›®å½•](../README.md)")
              
              # å†™å…¥ README
              readme_path = os.path.join(category_path, "README.md")
              with open(readme_path, "w", encoding="utf-8") as f:
                  f.write("\n".join(lines))
              
              print(f"âœ… ç”Ÿæˆåˆ†ç±» README: {readme_path}")
          
          # ä¸ºæ¯ä¸ªåˆ†ç±»ç”Ÿæˆ README
          for category in os.listdir(OUTPUT_BASE):
              category_path = os.path.join(OUTPUT_BASE, category)
              if os.path.isdir(category_path):
                  generate_category_readme(category_path, category)
          
          # ç”Ÿæˆä¸» README
          main_lines = []
          main_lines.append("# ğŸ“¦ OpenClash è¦†å†™é…ç½®æ–‡ä»¶")
          main_lines.append("")
          main_lines.append("> ğŸ¤– **è‡ªåŠ¨ç”Ÿæˆ** | åŸºäºä¸»ä»“åº“é…ç½®æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„ OpenClash ä¸“ç”¨è¦†å†™é…ç½®")
          main_lines.append("")
          main_lines.append("## ğŸ“‚ åˆ†ç±»ç›®å½•")
          main_lines.append("")
          
          for category in sorted(os.listdir(OUTPUT_BASE)):
              category_path = os.path.join(OUTPUT_BASE, category)
              if os.path.isdir(category_path):
                  desc = CATEGORY_DESC.get(category, "é…ç½®æ–‡ä»¶")
                  main_lines.append(f"- ğŸ“ **[{category}](./{category}/README.md)** - {desc}")
          
          main_lines.append("")
          main_lines.append("## ğŸš€ å¿«é€Ÿå¼€å§‹")
          main_lines.append("")
          main_lines.append("1. é€‰æ‹©å¯¹åº”åˆ†ç±»ï¼Œæ‰¾åˆ°ä½ éœ€è¦çš„é…ç½®æ–‡ä»¶")
          main_lines.append("2. ç‚¹å‡» `.conf` æ–‡ä»¶ï¼Œè·å– Raw é“¾æ¥")
          main_lines.append("3. åœ¨ OpenClash ä¸­æ·»åŠ é…ç½®æ–‡ä»¶è®¢é˜…")
          main_lines.append("4. é…ç½®ç¯å¢ƒå˜é‡åä¿å­˜ç”Ÿæ•ˆ")
          main_lines.append("")
          main_lines.append("[ğŸ  è¿”å›é¡¹ç›®ä¸»é¡µ](../README.md)")
          
          main_readme = os.path.join(OUTPUT_BASE, "README.md")
          with open(main_readme, "w", encoding="utf-8") as f:
              f.write("\n".join(main_lines))
          
          print(f"âœ… ç”Ÿæˆä¸» README: {main_readme}")
          PYTHON_SCRIPT

      - name: æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add OpenClash_Overview/
          git commit -m "Auto: Generate OpenClash overwrite configs" || echo "No changes to commit"
          
          git push origin HEAD:${{ github.ref_name }}
