name: Reusable - Download Binaries

on:
  workflow_call:
    inputs:
      project:
        description: 'é¡¹ç›®åç§° (mihomo)'
        required: true
        type: string
      variant:
        description: 'å˜ä½“æ ‡è¯† (meta | alpha | smart)'
        required: true
        type: string
      version:
        description: 'ç‰ˆæœ¬å· (ä»version.txtè·å–çš„ç¡®åˆ‡ç‰ˆæœ¬å­—ç¬¦ä¸²)'
        required: true
        type: string

jobs:
  download:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux
          - { platform: linux, arch: amd64-v1 } # æ–‡ä»¶åé€šå¸¸ä¸º amd64
          - { platform: linux, arch: amd64-v3 }
          - { platform: linux, arch: armv5 }
          - { platform: linux, arch: armv6 }
          - { platform: linux, arch: armv7 }
          - { platform: linux, arch: arm64 }
          - { platform: linux, arch: mips-softfloat }
          - { platform: linux, arch: mipsle-softfloat }
          - { platform: linux, arch: mipsle-hardfloat }
          # Windows
          - { platform: windows, arch: amd64-v1 }
          - { platform: windows, arch: amd64-v3 }
          - { platform: windows, arch: arm64 }
          # macOS (Smartç‰ˆæœ¬é€šå¸¸æ²¡æœ‰macOS/Androidï¼Œè„šæœ¬é‡Œä¼šå®¹é”™)
          - { platform: darwin, arch: amd64 }
          - { platform: darwin, arch: arm64 }
          # Android
          - { platform: android, arch: arm64 }
      fail-fast: false
    
    steps:
      - name: Checkoutä¸»ä»“åº“
        uses: actions/checkout@v4

      - name: ä¸‹è½½å¹¶å¤„ç†
        run: |
          mkdir -p ./artifacts ./tmp
          
          # === 1. æ¶æ„åç§°æ ‡å‡†åŒ– ===
          # çŸ©é˜µä¸­ä½¿ç”¨ amd64-v1 æ˜¯ä¸ºäº†åŒºåˆ† v3ï¼Œä½†åœ¨æ–‡ä»¶åä¸­é€šå¸¸åªæ˜¯ amd64
          FILE_ARCH="${{ matrix.arch }}"
          if [[ "$FILE_ARCH" == "amd64-v1" ]]; then
            FILE_ARCH="amd64"
          fi
          
          # === 2. æ„é€ æ–‡ä»¶åå’Œ URL ===
          # é€šç”¨æ–‡ä»¶åå‰ç¼€: mihomo-{platform}-{arch}
          FILE_PREFIX="mihomo-${{ matrix.platform }}-${FILE_ARCH}"
          
          case "${{ inputs.variant }}" in
            meta)
              # æ­£å¼ç‰ˆï¼šTag å’Œ Version æ˜¯ä¸€æ ·çš„
              DOWNLOAD_URL="https://github.com/MetaCubeX/mihomo/releases/download/${{ inputs.version }}"
              # æ–‡ä»¶ååç¼€éœ€é€‚é…ç‰ˆæœ¬
              FN_VERSION="${{ inputs.version }}"
              ;;
            alpha)
              # Alphaç‰ˆï¼šå›ºå®š Tag ä¸º Prerelease-Alpha
              DOWNLOAD_URL="https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha"
              # æ–‡ä»¶åä½¿ç”¨ä» version.txt è·å–çš„çœŸå®ç‰ˆæœ¬ (e.g., alpha-xxxx)
              FN_VERSION="${{ inputs.version }}"
              ;;
            smart)
              # Smartç‰ˆï¼šå›ºå®š Tag ä¸º Prerelease-Alpha
              DOWNLOAD_URL="https://github.com/vernesong/mihomo/releases/download/Prerelease-Alpha"
              # æ–‡ä»¶åä½¿ç”¨ä» version.txt è·å–çš„çœŸå®ç‰ˆæœ¬
              FN_VERSION="${{ inputs.version }}"
              ;;
            *)
              echo "æœªçŸ¥å˜ä½“: ${{ inputs.variant }}"
              exit 1
              ;;
          esac

          echo "ğŸ” å‡†å¤‡ä¸‹è½½: ${{ inputs.project }} (${{ inputs.variant }})"
          echo "ğŸ·ï¸  Tag/Base: $DOWNLOAD_URL"
          echo "ğŸ”¢ Version:  $FN_VERSION"
          echo "ğŸ’» Platform: ${{ matrix.platform }} / $FILE_ARCH"

          # === 3. æ‰§è¡Œä¸‹è½½ ===
          set +e # å…è®¸ä¸‹è½½å¤±è´¥ä»¥ä¾¿å¤„ç†ä¸åŒå¹³å°çš„æ‰©å±•åå·®å¼‚
          SUCCESS=0
          
          # --- Linux / Android (é€šå¸¸æ˜¯ .gz) ---
          if [[ "${{ matrix.platform }}" == "linux" || "${{ matrix.platform }}" == "android" ]]; then
            # æ‹¼æ¥ç›®æ ‡æ–‡ä»¶å: mihomo-linux-amd64-{version}.gz
            URL="${DOWNLOAD_URL}/${FILE_PREFIX}-${FN_VERSION}.gz"
            echo "â¬‡ï¸  å°è¯•ä¸‹è½½: $URL"
            
            curl -fSL --connect-timeout 10 --max-time 300 "$URL" -o ./tmp/mihomo.gz
            if [[ $? -eq 0 && -s ./tmp/mihomo.gz ]]; then
              gunzip -c ./tmp/mihomo.gz > ./tmp/mihomo
              chmod +x ./tmp/mihomo
              SOURCE_FILE="./tmp/mihomo"
              SUCCESS=1
            fi
            
          # --- Windows (é€šå¸¸æ˜¯ .zip) ---
          elif [[ "${{ matrix.platform }}" == "windows" ]]; then
            URL="${DOWNLOAD_URL}/${FILE_PREFIX}-${FN_VERSION}.zip"
            echo "â¬‡ï¸  å°è¯•ä¸‹è½½: $URL"
            
            curl -fSL --connect-timeout 10 --max-time 300 "$URL" -o ./tmp/download.zip
            if [[ $? -eq 0 && -s ./tmp/download.zip ]]; then
              unzip -q ./tmp/download.zip -d ./tmp/
              # æŸ¥æ‰¾è§£å‹å‡ºçš„ exe æ–‡ä»¶
              SOURCE_FILE=$(find ./tmp -name "*.exe" | head -n1)
              SUCCESS=1
            fi

          # --- macOS (å¯èƒ½æ˜¯ .gz æˆ– .zip) ---
          elif [[ "${{ matrix.platform }}" == "darwin" ]]; then
            # å…ˆè¯• .gz
            URL="${DOWNLOAD_URL}/${FILE_PREFIX}-${FN_VERSION}.gz"
            echo "â¬‡ï¸  å°è¯•ä¸‹è½½(gz): $URL"
            curl -fSL --connect-timeout 10 --max-time 300 "$URL" -o ./tmp/mihomo.gz
            
            if [[ $? -eq 0 && -s ./tmp/mihomo.gz ]]; then
              gunzip -c ./tmp/mihomo.gz > ./tmp/mihomo
              chmod +x ./tmp/mihomo
              SOURCE_FILE="./tmp/mihomo"
              SUCCESS=1
            else
              # å¤±è´¥åˆ™è¯• .zip
              URL="${DOWNLOAD_URL}/${FILE_PREFIX}-${FN_VERSION}.zip"
              echo "â¬‡ï¸  å°è¯•ä¸‹è½½(zip): $URL"
              curl -fSL --connect-timeout 10 --max-time 300 "$URL" -o ./tmp/download.zip
              if [[ $? -eq 0 && -s ./tmp/download.zip ]]; then
                unzip -q ./tmp/download.zip -d ./tmp/
                SOURCE_FILE=$(find ./tmp -type f ! -name "*.zip" | head -n1)
                chmod +x "$SOURCE_FILE"
                SUCCESS=1
              fi
            fi
          fi
          
          set -e # æ¢å¤é”™è¯¯ä¸­æ–­

          # === 4. éªŒè¯ä¸å¤„ç† ===
          if [[ $SUCCESS -eq 1 && -f "$SOURCE_FILE" ]]; then
            echo "âœ… ä¸‹è½½æˆåŠŸ"
            
            # è°ƒç”¨ artifact-handler.sh è¿›è¡Œé‡å‘½åå’Œç§»åŠ¨
            # æ³¨æ„ï¼šè¿™é‡Œä¼ é€’åŸå§‹çš„ amd64-v1 ç»™ handlerï¼Œä»¥ä¾¿ç”ŸæˆåŒºåˆ† v1/v3 çš„æ–‡ä»¶å
            bash .github/scripts/lib/artifact-handler.sh \
              "$SOURCE_FILE" \
              "${{ inputs.project }}" \
              "${{ inputs.variant }}" \
              "${{ matrix.platform }}" \
              "${{ matrix.arch }}" \
              "./artifacts"
          else
            echo "âš ï¸  ä¸‹è½½å¤±è´¥æˆ–è¯¥å˜ä½“ä¸æ”¯æŒæ­¤å¹³å° ($URL)"
            # ä¸æŠ¥é”™é€€å‡ºï¼Œå…è®¸çŸ©é˜µä¸­å…¶ä»–ä»»åŠ¡ç»§ç»­
            exit 0
          fi

      - name: ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.project }}-${{ inputs.variant }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: ./artifacts/*
          retention-days: 1
        if: ${{ hashFiles('./artifacts/*') != '' }}
